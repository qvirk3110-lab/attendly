<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendly</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      :root, html.light {
        --radius-sm: 0.25rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        
        --color-bg: #f8fafc; /* slate-50 */
        --color-text: #0f172a; /* slate-900 */
        --color-text-muted: #64748b; /* slate-500 */
        --color-card-bg: #ffffff; /* white */
        --color-border: #e2e8f0; /* slate-200 */
        --color-primary: #6366f1; /* indigo-500 */
        --color-primary-rgb: 99, 102, 241;
        --color-primary-hover: #4f46e5; /* indigo-600 */
        --color-primary-text: #ffffff;
        --color-secondary-bg: #f1f5f9; /* slate-100 */
        --color-secondary-hover: #e2e8f0; /* slate-200 */
        --color-secondary-text: #334155; /* slate-700 */
        --color-success: #22c55e; /* green-500 */
        --color-success-hover: #16a34a; /* green-600 */
      }
      html.dark {
        --color-bg: #020617; /* slate-950 */
        --color-text: #e2e8f0; /* slate-200 */
        --color-text-muted: #94a3b8; /* slate-400 */
        --color-card-bg: #0f172a; /* slate-900 */
        --color-border: #1e293b; /* slate-800 */
        --color-primary: #818cf8; /* indigo-400 */
        --color-primary-rgb: 129, 140, 248;
        --color-primary-hover: #a5b4fc; /* indigo-300 */
        --color-primary-text: #1e293b;
        --color-secondary-bg: #1e293b; /* slate-800 */
        --color-secondary-hover: #334155; /* slate-700 */
        --color-secondary-text: #e2e8f0; /* slate-200 */
        --color-success: #4ade80; /* green-400 */
        --color-success-hover: #86efac; /* green-300 */
      }
      html.sunset {
        --color-bg: #0f051e;
        --color-text: #e0e0e0;
        --color-text-muted: #a9a9a9;
        --color-card-bg: #1e0e3b;
        --color-border: #3a2d56;
        --color-primary: #e53170;
        --color-primary-rgb: 229, 49, 112;
        --color-primary-hover: #ff4785;
        --color-primary-text: #ffffff;
        --color-secondary-bg: #3a2d56;
        --color-secondary-hover: #4e3d70;
        --color-secondary-text: #e0e0e0;
        --color-success: #1ee698;
        --color-success-hover: #4affb5;
      }
      html.forest {
        --color-bg: #f0fdf4; /* green-50 */
        --color-text: #1a202c;
        --color-text-muted: #4a5568;
        --color-card-bg: #ffffff;
        --color-border: #e2e8f0;
        --color-primary: #2f855a; /* green-800 */
        --color-primary-rgb: 47, 133, 90;
        --color-primary-hover: #276749; /* green-900 */
        --color-primary-text: #ffffff;
        --color-secondary-bg: #d1fae5; /* green-100 */
        --color-secondary-hover: #a7f3d0; /* green-200 */
        --color-secondary-text: #1f2937;
        --color-success: #38a169;
        --color-success-hover: #2f855a;
      }
      html.ocean {
        --color-bg: #f0f9ff; /* sky-50 */
        --color-text: #0c4a6e; /* sky-900 */
        --color-text-muted: #38bdf8; /* sky-400 */
        --color-card-bg: #ffffff;
        --color-border: #bae6fd; /* sky-200 */
        --color-primary: #0369a1; /* sky-800 */
        --color-primary-rgb: 3, 105, 161;
        --color-primary-hover: #075985; /* sky-900 */
        --color-primary-text: #ffffff;
        --color-secondary-bg: #e0f2fe; /* sky-100 */
        --color-secondary-hover: #bae6fd; /* sky-200 */
        --color-secondary-text: #0c4a6e;
        --color-success: #059669;
        --color-success-hover: #047857;
      }

      * {
        scroll-behavior: smooth;
      }
      
      body {
        background-color: var(--color-bg);
        color: var(--color-text);
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        transition: background-color 0.3s ease, color 0.3s ease;
        background-image: radial-gradient(var(--color-border) 1px, transparent 0);
        background-size: 25px 25px;
      }
      
      ::selection {
        background-color: rgba(var(--color-primary-rgb), 0.2);
        color: var(--color-text);
      }
      
      kbd {
        background-color: var(--color-secondary-bg);
        color: var(--color-secondary-text);
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-sm);
        font-family: monospace;
        font-size: 0.9em;
      }

      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: var(--color-bg);
      }
      ::-webkit-scrollbar-thumb {
        background-color: var(--color-secondary-hover);
        border-radius: 10px;
        border: 3px solid var(--color-bg);
      }
      ::-webkit-scrollbar-thumb:hover {
        background-color: var(--color-border);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback, useMemo, forwardRef, StrictMode } = React;

      // --- Enums and Types ---
      const AttendanceStatus = {
        PRESENT: 'Present',
        ABSENT: 'Absent',
        LEAVE: 'Leave',
        BUNK: 'Bunk',
      };

      // --- UTILS ---
      const formatDate = (timestamp) => {
        return new Date(timestamp).toLocaleString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        });
      };

      const sortStudents = (students) => {
        return [...students].sort((a, b) => 
          a.roll.localeCompare(b.roll, undefined, { numeric: true, sensitivity: 'base' })
        );
      };

      const generatePdfFilename = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `attendance_${year}-${month}-${day}_${hours}-${minutes}-${seconds}.pdf`;
      };
      
      const generateCsvFilename = (prefix) => {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const day = String(now.getDate()).padStart(2, '0');
          return `${prefix}_${year}-${month}-${day}.csv`;
      }
      
      const purgeOldHistory = (history, days) => {
          const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
          return history.filter(entry => entry.timestamp >= cutoff);
      }

      const getAttendanceCounts = (attendanceData) => {
          let presentCount = 0;
          let absentCount = 0;
          let leaveCount = 0;
          let bunkCount = 0;

          attendanceData.forEach(record => {
              if (record.status === AttendanceStatus.PRESENT) presentCount++;
              else if (record.status === AttendanceStatus.ABSENT) absentCount++;
              else if (record.status === AttendanceStatus.LEAVE) leaveCount++;
              else if (record.status === AttendanceStatus.BUNK) bunkCount++;
          });

          return { presentCount, absentCount, leaveCount, bunkCount };
      };

      const getStudentListsByStatus = (students, attendanceData) => {
          const presentStudents = [];
          const absentStudents = [];
          const leaveStudents = [];
          const bunkStudents = [];

          const sorted = sortStudents(students);

          for (const student of sorted) {
              const record = attendanceData.get(student.roll);
              if (record) {
                  switch(record.status) {
                      case AttendanceStatus.PRESENT:
                          presentStudents.push(student);
                          break;
                      case AttendanceStatus.ABSENT:
                          absentStudents.push(student);
                          break;
                      case AttendanceStatus.LEAVE:
                          leaveStudents.push({student, reason: record.reason});
                          break;
                      case AttendanceStatus.BUNK:
                          bunkStudents.push(student);
                          break;
                  }
              }
          }
          return { presentStudents, absentStudents, leaveStudents, bunkStudents };
      };
      
      // --- HOOKS ---
      function useLocalStorage(key, initialValue) {
        const [storedValue, setStoredValue] = useState(() => {
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error)
{
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
          } catch (error) {
            console.error(error);
          }
        };

        useEffect(() => {
          const handleStorageChange = (e) => {
            if (e.key === key) {
              try {
                setStoredValue(e.newValue ? JSON.parse(e.newValue) : initialValue);
              } catch (error) {
                console.error(error);
              }
            }
          };

          window.addEventListener('storage', handleStorageChange);

          return () => {
            window.removeEventListener('storage', handleStorageChange);
          };
        }, [key, initialValue]);


        return [storedValue, setValue];
      }

      // --- ICONS ---
      const iconProps = {
        className: "w-5 h-5 inline-block",
        viewBox: "0 0 24 24",
        fill: "none",
        stroke: "currentColor",
        strokeWidth: "2",
        strokeLinecap: "round",
        strokeLinejoin: "round",
      };

      const CheckIcon = ({ className }) => (
        <svg {...iconProps} className={`${iconProps.className} ${className}`}><polyline points="20 6 9 17 4 12"></polyline></svg>
      );
      const XIcon = ({ className }) => (
        <svg {...iconProps} className={`${iconProps.className} ${className}`}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      );
      const FileTextIcon = ({ className }) => (
        <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
      );
      const UsersIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
      );
      const CalendarIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      );
      const SettingsIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      );
      const ListIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
      );
      const DownloadIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
      );
      const TrashIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      );
      const UploadIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
      );
      const PaletteIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path><path d="M12 22V12"></path><path d="M12 12H2"></path><path d="M12 12h10"></path></svg>
      );
      const EditIcon = ({ className }) => (
        <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
      );
      const BanIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
      );
      const SearchIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      );
      const InfoIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
      );
      const PhoneIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
      );
      const MailIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
      );
      const LogOutIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
      );
      const MenuIcon = ({ className }) => (
          <svg {...iconProps} className={`${iconProps.className} ${className}`}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      );
      
      // --- COMPONENTS ---

      const Modal = ({ isOpen, onClose, title, children, footer, hideCloseButton = false }) => {
        const modalRef = useRef(null);

        useEffect(() => {
          const handleKeyDown = (event) => {
            if (event.key === 'Escape' && !hideCloseButton) {
              onClose();
            }
          };

          if (isOpen) {
            document.addEventListener('keydown', handleKeyDown);
            modalRef.current?.focus();
          }

          return () => {
            document.removeEventListener('keydown', handleKeyDown);
          };
        }, [isOpen, onClose, hideCloseButton]);

        if (!isOpen) {
          return null;
        }

        return (
          <div
            className="fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center transition-opacity duration-300"
            aria-labelledby="modal-title"
            role="dialog"
            aria-modal="true"
            onClick={hideCloseButton ? undefined : onClose}
          >
            <div
              ref={modalRef}
              className="bg-[var(--color-card-bg)] rounded-[var(--radius-lg)] shadow-2xl m-4 max-w-lg w-full transform transition-all duration-300 ease-out scale-95 animate-scale-in border border-[var(--color-border)]"
              onClick={(e) => e.stopPropagation()}
              tabIndex={-1}
            >
              <div className="flex justify-between items-center p-5 border-b border-[var(--color-border)]">
                <h2 id="modal-title" className="text-xl font-semibold text-[var(--color-text)]">{title}</h2>
                {!hideCloseButton && (
                  <button
                    onClick={onClose}
                    className="text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors rounded-full p-1 hover:bg-[var(--color-secondary-hover)]"
                    aria-label="Close modal"
                  >
                    <XIcon />
                  </button>
                )}
              </div>
              <div className="p-6 text-[var(--color-text-muted)]">
                {children}
              </div>
              {footer && (
                <div className="px-6 py-4 bg-[var(--color-bg)] rounded-b-[var(--radius-lg)] flex flex-wrap justify-end gap-3 border-t border-[var(--color-border)]">
                  {footer}
                </div>
              )}
            </div>
            <style>{`
              @keyframes scale-in {
                  from { opacity: 0; transform: scale(0.95); }
                  to { opacity: 1; transform: scale(1); }
              }
              .animate-scale-in {
                  animation: scale-in 0.2s ease-out forwards;
              }
            `}</style>
          </div>
        );
      };
      
      const PdfDocument = forwardRef(({ students, attendanceData, settings, timestamp }, ref) => {
          const { presentCount, absentCount, leaveCount, bunkCount } = getAttendanceCounts(attendanceData);
          const sortedAllStudents = sortStudents(students);
          
          return (
              <div ref={ref} className="p-8 bg-white text-black" style={{ width: '210mm', minHeight: '297mm', fontFamily: 'sans-serif' }}>
                  <header className="mb-8 flex justify-between items-end border-b-2 border-gray-300 pb-4">
                      <div>
                        <h1 className="text-3xl font-bold text-gray-800">Attendance Report</h1>
                        {settings.schoolName && <h2 className="text-xl mt-1 text-gray-600">{settings.schoolName}</h2>}
                        {settings.className && <h3 className="text-lg text-gray-600">{settings.className}</h3>}
                      </div>
                      <div className="text-right">
                          <p className="text-lg font-semibold text-gray-700">{settings.teacherName}</p>
                          <p className="text-sm text-gray-500">{formatDate(timestamp)}</p>
                      </div>
                  </header>

                  <section className="mb-8">
                      <h3 className="text-xl font-semibold mb-4 border-b border-gray-200 pb-2 text-gray-700">Summary</h3>
                      <div className="grid grid-cols-4 gap-4 text-center">
                          <div className="bg-green-50 border border-green-200 p-4 rounded-lg shadow-sm">
                              <p className="text-3xl font-bold text-green-700">{presentCount}</p>
                              <p className="text-sm font-medium text-green-800">Present</p>
                          </div>
                          <div className="bg-red-50 border border-red-200 p-4 rounded-lg shadow-sm">
                              <p className="text-3xl font-bold text-red-600">{absentCount}</p>
                              <p className="text-sm font-medium text-red-800">Absent</p>
                          </div>
                          <div className="bg-orange-50 border border-orange-200 p-4 rounded-lg shadow-sm">
                              <p className="text-3xl font-bold text-orange-700">{bunkCount}</p>
                              <p className="text-sm font-medium text-orange-800">Bunk</p>
                          </div>
                          <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg shadow-sm">
                              <p className="text-3xl font-bold text-yellow-800">{leaveCount}</p>
                              <p className="text-sm font-medium text-yellow-900">On Leave</p>
                          </div>
                      </div>
                  </section>

                  <section>
                      <h3 className="text-xl font-semibold mb-4 border-b border-gray-200 pb-2 text-gray-700">Full Attendance List</h3>
                      <table className="w-full text-left border-collapse text-sm">
                          <thead>
                              <tr className="bg-gray-100 border-b-2 border-gray-300">
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Reg No.</th>
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Name</th>
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Program</th>
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Section</th>
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Status</th>
                                  <th scope="col" className="p-3 font-semibold text-gray-600">Reason</th>
                              </tr>
                          </thead>
                          <tbody>
                              {sortedAllStudents.map(student => {
                                  const record = attendanceData.get(student.roll);
                                  const status = record?.status || 'Not Marked';
                                  let statusClass = 'text-gray-500';

                                  switch (status) {
                                      case AttendanceStatus.PRESENT: statusClass = 'text-green-800 font-bold'; break;
                                      case AttendanceStatus.ABSENT: statusClass = 'text-red-700 font-bold'; break;
                                      case AttendanceStatus.LEAVE: statusClass = 'text-yellow-800 font-bold'; break;
                                      case AttendanceStatus.BUNK: statusClass = 'text-orange-800 font-bold'; break;
                                  }

                                  return (
                                      <tr key={student.roll} className="border-b border-gray-200 odd:bg-white even:bg-gray-50">
                                          <td className="p-3 text-gray-700 font-mono">{student.roll}</td>
                                          <td className="p-3 text-gray-800 font-medium">{student.name}</td>
                                          <td className="p-3 text-gray-700">{student.program}</td>
                                          <td className="p-3 text-gray-700">{student.section}</td>
                                          <td className={`p-3 ${statusClass}`}>{status}</td>
                                          <td className="p-3 text-gray-600 italic">{record?.status === AttendanceStatus.LEAVE ? (record.reason || '') : ''}</td>
                                      </tr>
                                  );
                              })}
                          </tbody>
                      </table>
                  </section>
                  <footer className="mt-8 pt-4 border-t border-gray-300 text-center text-xs text-gray-500">
                      <p>Generated by Attendly</p>
                      <p>© {new Date().getFullYear()} Ehtisham Sabir. All rights reserved.</p>
                  </footer>
              </div>
          );
      });

      const Login = ({ onLogin, error }) => {
        const [email, setEmail] = useState('uetteacher@gmail.com');
        const [password, setPassword] = useState('Qasim123@');

        const handleSubmit = (e) => {
          e.preventDefault();
          onLogin(email, password);
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-[var(--color-bg)] p-4">
            <div className="max-w-md w-full bg-[var(--color-card-bg)] p-8 rounded-2xl shadow-lg border border-[var(--color-border)]">
              <h1 className="text-5xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-[var(--color-primary)] to-pink-500 mb-2">Attendly</h1>
              <h2 className="text-lg font-medium text-center text-[var(--color-text-muted)] mb-8">Teacher Login</h2>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label htmlFor="email" className="block text-sm font-medium text-[var(--color-text-muted)]">Email Address</label>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="mt-1 block w-full p-3 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition"
                    placeholder="teacher@example.com"
                  />
                </div>
                <div>
                  <label htmlFor="password" className="block text-sm font-medium text-[var(--color-text-muted)]">Password</label>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    autoComplete="current-password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="mt-1 block w-full p-3 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition"
                    placeholder="••••••••"
                  />
                </div>
                {error && <p className="text-sm text-red-500 text-center">{error}</p>}
                <div>
                  <button
                    type="submit"
                    className="w-full flex justify-center py-3 px-4 border border-transparent rounded-[var(--radius-md)] shadow-sm text-sm font-semibold text-[var(--color-primary-text)] bg-[var(--color-primary)] hover:bg-[var(--color-primary-hover)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] transition-all transform hover:scale-105"
                  >
                    Sign in
                  </button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const AttendanceTaker = ({ students, setAttendance, onComplete }) => {
          const [currentIndex, setCurrentIndex] = useState(0);
          const [animationClass, setAnimationClass] = useState('');
          const [isLeaveModalOpen, setIsLeaveModalOpen] = useState(false);
          const [studentForLeave, setStudentForLeave] = useState(null);
          const [focusedReasonIndex, setFocusedReasonIndex] = useState(0);
          
          const LEAVE_REASONS = ['Sick', 'Family Event', 'Urgent Work', 'Personal Emergency'];
          const reasonButtonsRef = useRef([]);
          const sortedStudents = useMemo(() => sortStudents(students), [students]);
          const totalStudents = sortedStudents.length;

          useEffect(() => {
              if (currentIndex === totalStudents && totalStudents > 0) {
                  setTimeout(() => {
                      onComplete();
                  }, 400);
              }
          }, [currentIndex, totalStudents, onComplete]);

          const handleMarkAttendance = useCallback((studentRoll, status, reason) => {
              setAttendance(prev => new Map(prev).set(studentRoll, { status, reason }));
          }, [setAttendance]);

          const proceedToNextStudent = useCallback((animation) => {
              setAnimationClass(animation);
              setTimeout(() => {
                  setCurrentIndex(prev => prev + 1);
                  setAnimationClass('');
              }, 400);
          }, []);

          const handleAction = useCallback((status) => {
              if (animationClass || currentIndex >= totalStudents) return;

              const student = sortedStudents[currentIndex];
              
              if (status === AttendanceStatus.LEAVE) {
                  setStudentForLeave(student);
                  setFocusedReasonIndex(0); // Reset focus when opening modal
                  setIsLeaveModalOpen(true);
                  return;
              }

              handleMarkAttendance(student.roll, status);

              switch (status) {
                  case AttendanceStatus.PRESENT: proceedToNextStudent('animate-slide-out-right'); break;
                  case AttendanceStatus.ABSENT: proceedToNextStudent('animate-slide-out-left'); break;
                  case AttendanceStatus.BUNK: proceedToNextStudent('animate-slide-out-down'); break;
              }
          }, [animationClass, currentIndex, totalStudents, sortedStudents, handleMarkAttendance, proceedToNextStudent]);

          useEffect(() => {
              const handleKeyDown = (event) => {
                  if (isLeaveModalOpen || animationClass) return;
                  
                  const target = event.target;
                  if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) return;

                  switch (event.key.toLowerCase()) {
                      case 'p': handleAction(AttendanceStatus.PRESENT); break;
                      case 'a': handleAction(AttendanceStatus.ABSENT); break;
                      case 'l': handleAction(AttendanceStatus.LEAVE); break;
                      case 'b': handleAction(AttendanceStatus.BUNK); break;
                  }
              };

              window.addEventListener('keydown', handleKeyDown);
              return () => window.removeEventListener('keydown', handleKeyDown);
          }, [handleAction, isLeaveModalOpen, animationClass]);
          
          useEffect(() => {
              const handleModalKeyDown = (event) => {
                  if (!isLeaveModalOpen) return;

                  if (event.key === 'ArrowDown') {
                      event.preventDefault();
                      setFocusedReasonIndex(prev => (prev + 1) % LEAVE_REASONS.length);
                  } else if (event.key === 'ArrowUp') {
                      event.preventDefault();
                      setFocusedReasonIndex(prev => (prev - 1 + LEAVE_REASONS.length) % LEAVE_REASONS.length);
                  } else if (event.key === 'Enter') {
                      event.preventDefault();
                      reasonButtonsRef.current[focusedReasonIndex]?.click();
                  }
              };
              
              document.addEventListener('keydown', handleModalKeyDown);
              return () => document.removeEventListener('keydown', handleModalKeyDown);
          }, [isLeaveModalOpen, focusedReasonIndex]);

          useEffect(() => {
              if (isLeaveModalOpen) {
                  reasonButtonsRef.current[focusedReasonIndex]?.focus();
              }
          }, [isLeaveModalOpen, focusedReasonIndex]);

          const handleSelectLeaveReason = (reason) => {
              if (!studentForLeave) return;
              handleMarkAttendance(studentForLeave.roll, AttendanceStatus.LEAVE, reason);
              setIsLeaveModalOpen(false);
              setStudentForLeave(null);
              proceedToNextStudent('animate-slide-out-up');
          };
          
          if (totalStudents === 0) {
              return (
                  <div className="bg-[var(--color-card-bg)] p-6 rounded-2xl shadow-md border border-[var(--color-border)] text-center">
                      <p className="text-center text-[var(--color-text-muted)] py-4">Please add students in the "Students" page first.</p>
                  </div>
              );
          }
          
          const currentStudent = sortedStudents[currentIndex];

          return (
              <div className="bg-[var(--color-card-bg)] p-6 rounded-2xl shadow-md border border-[var(--color-border)] flex flex-col items-center">
                  <p className="text-sm font-medium text-[var(--color-text-muted)] mb-4">{currentIndex} of {totalStudents} students marked</p>
                  
                  <div className="w-full bg-[var(--color-secondary-bg)] rounded-full h-2 mb-6 shadow-inner">
                      <div 
                          className="bg-gradient-to-r from-[var(--color-primary)] to-pink-500 h-2 rounded-full transition-all duration-300 ease-out" 
                          style={{ width: `${(currentIndex / totalStudents) * 100}%` }}
                      ></div>
                  </div>

                  <div className="relative w-full max-w-sm h-64 mb-6">
                      {currentIndex < totalStudents ? (
                          <div className={`absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 dark:from-indigo-900/20 dark:to-purple-900/20 border border-[var(--color-border)] rounded-2xl shadow-lg p-6 flex flex-col justify-center items-center text-center ${animationClass}`}>
                              <span className="font-mono text-lg bg-[var(--color-secondary-bg)] border border-[var(--color-border)] px-3 py-1 rounded-md mb-4 text-[var(--color-secondary-text)] shadow-sm">{currentStudent.roll}</span>
                              <h4 className="text-3xl font-bold text-[var(--color-text)]">{currentStudent.name}</h4>
                          </div>
                      ) : (
                          <div className="w-full h-full flex justify-center items-center bg-[var(--color-bg)] rounded-2xl border border-[var(--color-border)]">
                              <p className="text-[var(--color-text-muted)]">All students marked!</p>
                          </div>
                      )}
                  </div>

                  <div className="flex justify-center items-center space-x-2 sm:space-x-4">
                      <button aria-label="Mark Absent" onClick={() => handleAction(AttendanceStatus.ABSENT)} className="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-red-500/10 text-red-500 flex justify-center items-center shadow-lg hover:bg-red-500/20 transform hover:scale-110 transition-all duration-200 disabled:opacity-50" disabled={!!animationClass}>
                          <XIcon className="w-8 h-8 sm:w-10 sm:h-10"/>
                      </button>
                      <button aria-label="Mark Bunk" onClick={() => handleAction(AttendanceStatus.BUNK)} className="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-orange-500/10 text-orange-500 flex justify-center items-center shadow-lg hover:bg-orange-500/20 transform hover:scale-110 transition-all duration-200 disabled:opacity-50" disabled={!!animationClass}>
                          <BanIcon className="w-8 h-8 sm:w-9 sm:h-9"/>
                      </button>
                      <button aria-label="Mark On Leave" onClick={() => handleAction(AttendanceStatus.LEAVE)} className="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-yellow-500/10 text-yellow-500 flex justify-center items-center shadow-lg hover:bg-yellow-500/20 transform hover:scale-110 transition-all duration-200 disabled:opacity-50" disabled={!!animationClass}>
                          <FileTextIcon className="w-7 h-7 sm:w-9 sm:h-9"/>
                      </button>
                      <button aria-label="Mark Present" onClick={() => handleAction(AttendanceStatus.PRESENT)} className="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-green-500/10 text-green-500 flex justify-center items-center shadow-lg hover:bg-green-500/20 transform hover:scale-110 transition-all duration-200 disabled:opacity-50" disabled={!!animationClass}>
                          <CheckIcon className="w-8 h-8 sm:w-10 sm:h-10"/>
                      </button>
                  </div>
                  
                  <p className="text-sm text-[var(--color-text-muted)] mt-6">
                      Pro Tip: Use <kbd>P</kbd>, <kbd>A</kbd>, <kbd>L</kbd>, <kbd>B</kbd> keys for quick marking.
                  </p>

                  <Modal
                      isOpen={isLeaveModalOpen}
                      onClose={() => { setIsLeaveModalOpen(false); setStudentForLeave(null); }}
                      title={`Reason for Leave: ${studentForLeave?.name || ''}`}
                  >
                      <div className="flex flex-col space-y-3">
                          {LEAVE_REASONS.map((reason, index) => (
                              <button 
                                  key={reason}
                                  ref={el => { reasonButtonsRef.current[index] = el; }}
                                  onClick={() => handleSelectLeaveReason(reason)} 
                                  className={`w-full text-left p-3 rounded-[var(--radius-md)] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] ${
                                      focusedReasonIndex === index
                                          ? 'bg-[var(--color-primary)] text-[var(--color-primary-text)] font-semibold shadow-md'
                                          : 'bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] hover:bg-[var(--color-secondary-hover)]'
                                  }`}
                              >
                                  {reason}
                              </button>
                          ))}
                      </div>
                  </Modal>

              </div>
          );
      };

      const HistoryViewer = ({ history, setHistory, onRegeneratePdf, isGeneratingPdf, addToast }) => {
        const [dateFilter, setDateFilter] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        const [entryToDelete, setEntryToDelete] = useState(null);

        const handleDelete = () => {
          if (!entryToDelete) return;
          setHistory(prev => prev.filter(entry => entry.id !== entryToDelete.id));
          addToast('History entry deleted successfully.', 'success');
          setEntryToDelete(null);
        };

        const handleDownload = (entry) => {
          onRegeneratePdf(entry);
        };
        
        const sortedAndFilteredHistory = [...history]
          .sort((a, b) => b.timestamp - a.timestamp)
          .filter(entry => {
            if (!dateFilter) return true;
            const entryDate = new Date(entry.timestamp);
            const filterDateUTC = new Date(dateFilter);
            const filterDateLocal = new Date(filterDateUTC.getUTCFullYear(), filterDateUTC.getUTCMonth(), filterDateUTC.getUTCDate());

            return entryDate.getFullYear() === filterDateLocal.getFullYear() &&
                  entryDate.getMonth() === filterDateLocal.getMonth() &&
                  entryDate.getDate() === filterDateLocal.getDate();
          })
          .filter(entry => {
              if (!searchTerm) return true;
              const lowerSearch = searchTerm.toLowerCase();
              return (
                  (entry.settings.className && entry.settings.className.toLowerCase().includes(lowerSearch)) ||
                  (entry.settings.teacherName && entry.settings.teacherName.toLowerCase().includes(lowerSearch)) ||
                  (entry.settings.schoolName && entry.settings.schoolName.toLowerCase().includes(lowerSearch)) ||
                  formatDate(entry.timestamp).toLowerCase().includes(lowerSearch)
              )
          });
        
        const inputClass = "p-2 pl-10 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";

        return (
          <div className="bg-[var(--color-card-bg)] p-4 sm:p-6 rounded-2xl shadow-md border border-[var(--color-border)]">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 flex-wrap">
              <div className="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-2">
                  <div className="w-full sm:w-auto relative">
                      <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--color-text-muted)] pointer-events-none" />
                      <input 
                          type="text"
                          placeholder="Search..."
                          value={searchTerm}
                          onChange={e => setSearchTerm(e.target.value)}
                          className={`w-full sm:w-auto ${inputClass}`}
                          aria-label="Search history"
                      />
                  </div>
                  <div className="w-full sm:w-auto relative">
                    <CalendarIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--color-text-muted)] pointer-events-none" />
                    <input 
                        type="date"
                        id="history-date-filter"
                        value={dateFilter}
                        onChange={e => setDateFilter(e.target.value)}
                        className={`w-full sm:w-auto ${inputClass}`}
                        aria-label="Filter history by date"
                    />
                  </div>
                  {(dateFilter || searchTerm) && (
                      <button onClick={() => { setDateFilter(''); setSearchTerm(''); }} className="p-2 bg-[var(--color-secondary-bg)] text-[var(--color-text-muted)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition" aria-label="Clear filters"><XIcon/></button>
                  )}
              </div>
            </div>
            <div className="space-y-4 max-h-[70vh] overflow-y-auto -mr-3 pr-3">
              {sortedAndFilteredHistory.length > 0 ? (
                sortedAndFilteredHistory.map(entry => (
                  <div key={entry.id} className="p-4 rounded-[var(--radius-lg)] bg-[var(--color-bg)] border border-[var(--color-border)] flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 hover:shadow-md hover:border-[var(--color-primary)]/50 transition-all duration-200">
                    <div>
                      <p className="font-bold text-[var(--color-text)]">{entry.settings.className || 'Attendance Report'}</p>
                      <p className="text-sm text-[var(--color-text-muted)]">{formatDate(entry.timestamp)}</p>
                      <div className="flex flex-wrap gap-x-4 gap-y-1 text-sm mt-2">
                        <span className="text-green-500 font-medium">Present: {entry.presentCount}</span>
                        <span className="text-red-500 font-medium">Absent: {entry.absentCount}</span>
                        <span className="text-yellow-500 font-medium">Leave: {entry.leaveCount}</span>
                        <span className="text-orange-500 font-medium">Bunk: {entry.bunkCount}</span>
                      </div>
                    </div>
                    <div className="flex gap-2 shrink-0 self-end sm:self-center">
                      <button 
                        onClick={() => handleDownload(entry)} 
                        disabled={isGeneratingPdf}
                        className="p-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition disabled:opacity-50 disabled:cursor-wait" 
                        aria-label="Download PDF"
                      >
                        <DownloadIcon/>
                      </button>
                      <button onClick={() => setEntryToDelete(entry)} className="p-2 text-red-500 bg-red-500/10 rounded-[var(--radius-md)] hover:bg-red-500/20 transition" aria-label="Delete entry"><TrashIcon/></button>
                    </div>
                  </div>
                ))
              ) : (
                <p className="text-center text-[var(--color-text-muted)] py-8">{history.length > 0 ? 'No history found for the selected filter.' : 'No history found.'}</p>
              )}
            </div>
            
            <Modal
              isOpen={!!entryToDelete}
              onClose={() => setEntryToDelete(null)}
              title="Confirm Deletion"
              footer={
                  <>
                      <button onClick={() => setEntryToDelete(null)} className="px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium">Cancel</button>
                      <button onClick={handleDelete} className="px-4 py-2 bg-red-600 text-white rounded-[var(--radius-md)] hover:bg-red-700 transition font-medium">Delete</button>
                  </>
              }
            >
                <p>Are you sure you want to delete this history entry from {entryToDelete ? formatDate(entryToDelete.timestamp) : ''}? This action cannot be undone.</p>
            </Modal>
          </div>
        );
      };
      
      const TeacherProfileForm = ({ initialTeacher, onSave, addToast }) => {
          const [teacherForm, setTeacherForm] = useState({ ...initialTeacher, confirmPassword: initialTeacher.password });

          const handleChange = (e) => {
              setTeacherForm(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              if (teacherForm.password !== teacherForm.confirmPassword) {
                  addToast("Passwords do not match.", 'error');
                  return;
              }
              if (!teacherForm.password) {
                  addToast("Password cannot be empty.", 'error');
                  return;
              }
              const { confirmPassword, ...teacherToSave } = teacherForm;
              onSave(teacherToSave);
              addToast("Teacher profile updated successfully!", 'success');
          };
          
          const inputClass = "mt-1 block w-full p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";

          return (
            <form onSubmit={handleSubmit}>
                <div className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label htmlFor="name" className="block text-sm font-medium text-[var(--color-text-muted)]">Display Name</label>
                            <input type="text" id="name" name="name" value={teacherForm.name} onChange={handleChange} required className={inputClass}/>
                        </div>
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-[var(--color-text-muted)]">Email</label>
                            <input type="email" id="email" name="email" value={teacherForm.email} onChange={handleChange} required className={inputClass}/>
                        </div>
                        <div>
                            <label htmlFor="password" className="block text-sm font-medium text-[var(--color-text-muted)]">New Password</label>
                            <input type="password" id="password" name="password" value={teacherForm.password} onChange={handleChange} required className={inputClass}/>
                        </div>
                        <div>
                            <label htmlFor="confirmPassword" className="block text-sm font-medium text-[var(--color-text-muted)]">Confirm New Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" value={teacherForm.confirmPassword} onChange={handleChange} required className={inputClass}/>
                        </div>
                    </div>
                    <div className="text-right pt-2">
                        <button type="submit" className="px-5 py-2 bg-[var(--color-primary)] text-[var(--color-primary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-primary-hover)] transition font-semibold">Save Profile</button>
                    </div>
                </div>
            </form>
          );
      };

      const PdfDetailsForm = ({ initialSettings, onSettingsChange }) => {
          const [formState, setFormState] = useState(initialSettings);
          
          useEffect(() => {
              const handler = setTimeout(() => {
                  onSettingsChange(formState);
              }, 500);

              return () => {
                  clearTimeout(handler);
              };
          }, [formState, onSettingsChange]);
          
          useEffect(() => {
            setFormState(initialSettings);
          }, [initialSettings]);

          const handleChange = (e) => {
              setFormState(prev => ({ ...prev, [e.target.name]: e.target.value }));
          };
          
          const inputClass = "mt-1 block w-full p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";


          return (
            <div className="space-y-4">
                <div>
                    <label htmlFor="schoolName" className="block text-sm font-medium text-[var(--color-text-muted)]">School Name</label>
                    <input type="text" id="schoolName" name="schoolName" value={formState.schoolName} onChange={handleChange} className={inputClass} placeholder="e.g., Northwood High"/>
                </div>
                <div>
                    <label htmlFor="className" className="block text-sm font-medium text-[var(--color-text-muted)]">Class Name</label>
                    <input type="text" id="className" name="className" value={formState.className} onChange={handleChange} className={inputClass} placeholder="e.g., Grade 5 - Section B"/>
                </div>
                <div>
                    <label htmlFor="teacherName" className="block text-sm font-medium text-[var(--color-text-muted)]">Teacher Name (on PDF)</label>
                    <input type="text" id="teacherName" name="teacherName" value={formState.teacherName} onChange={handleChange} className={inputClass} placeholder="e.g., Mr. John Doe"/>
                </div>
            </div>
          );
      };

      const SettingsEditor = ({ settings, setSettings, teacher, setTeacher, theme, setTheme, fontSize, setFontSize, onOpenAbout, addToast }) => {
          const themes = [
              { id: 'light', name: 'Light', color: '#f8fafc' },
              { id: 'dark', name: 'Dark', color: '#0f172a' },
              { id: 'sunset', name: 'Sunset', color: '#1e0e3b' },
              { id: 'forest', name: 'Forest', color: '#f0fdf4' },
              { id: 'ocean', name: 'Ocean', color: '#f0f9ff' },
          ];

          const fontSizes = [
              { id: 'small', name: 'S' },
              { id: 'medium', name: 'M' },
              { id: 'large', name: 'L' },
          ];

          const FieldsetCard = ({ title, children }) => (
              <div className="bg-[var(--color-card-bg)] p-6 rounded-2xl shadow-md border border-[var(--color-border)]">
                  <h4 className="text-lg font-semibold text-[var(--color-text)] mb-4">{title}</h4>
                  {children}
              </div>
          );

          return (
              <div className="max-w-3xl mx-auto space-y-6">
                  <FieldsetCard title="Teacher Profile">
                      <TeacherProfileForm initialTeacher={teacher} onSave={setTeacher} addToast={addToast} />
                  </FieldsetCard>

                  <FieldsetCard title="PDF Report Details">
                      <PdfDetailsForm initialSettings={settings} onSettingsChange={setSettings} />
                  </FieldsetCard>

                  <FieldsetCard title="Appearance">
                      <div className="space-y-6">
                          <div>
                              <label className="block text-sm font-medium text-[var(--color-text-muted)] mb-2 flex items-center"><PaletteIcon className="mr-2" /> Theme</label>
                              <div className="flex flex-wrap gap-3">
                                  {themes.map(t => (
                                      <button key={t.id} onClick={() => setTheme(t.id)} className={`px-4 py-2 rounded-[var(--radius-md)] text-sm font-medium transition-all duration-200 flex items-center gap-2 border ${theme === t.id ? 'bg-[var(--color-primary)] text-[var(--color-primary-text)] border-transparent shadow-md' : 'bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] hover:bg-[var(--color-secondary-hover)] border-[var(--color-border)]'}`}>
                                          <span className="w-4 h-4 rounded-full border border-gray-400/50" style={{ backgroundColor: t.color }}></span>
                                          {t.name}
                                      </button>
                                  ))}
                              </div>
                          </div>
                          <div>
                              <label className="block text-sm font-medium text-[var(--color-text-muted)] mb-2">Font Size</label>
                              <div className="flex gap-2">
                                  {fontSizes.map(fs => (
                                      <button key={fs.id} onClick={() => setFontSize(fs.id)} className={`w-10 h-10 rounded-[var(--radius-md)] text-sm font-medium transition flex items-center justify-center border ${fontSize === fs.id ? 'bg-[var(--color-primary)] text-[var(--color-primary-text)] border-transparent shadow-md' : 'bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] hover:bg-[var(--color-secondary-hover)] border-[var(--color-border)]'}`}>{fs.name}</button>
                                  ))}
                              </div>
                          </div>
                      </div>
                  </FieldsetCard>
                  
                  <FieldsetCard title="About">
                      <button onClick={onOpenAbout} className="px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition text-sm font-medium">About Attendly</button>
                  </FieldsetCard>

                  <p className="text-xs text-[var(--color-text-muted)] mt-8 text-center">All settings are saved automatically to your browser.</p>
              </div>
          );
      };

      const EditStudentForm = ({ student, onSave }) => {
          const [formData, setFormData] = useState(student);

          useEffect(() => {
              setFormData(student);
          }, [student]);

          const handleChange = (e) => {
              const { name, value } = e.target;
              setFormData(prev => ({ ...prev, [name]: value }));
          };

          const handleSubmit = (e) => {
              e.preventDefault();
              onSave(formData);
          };
          
          const inputClass = "mt-1 w-full p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";

          return (
              <form id="edit-student-form" className="space-y-4" onSubmit={handleSubmit}>
                  <div>
                    <label htmlFor="edit-roll" className="block text-sm font-medium text-[var(--color-text-muted)]">Reg No.</label>
                    <input type="text" id="edit-roll" value={formData.roll} disabled className={`${inputClass} cursor-not-allowed text-[var(--color-text-muted)]`}/>
                  </div>
                  <div>
                    <label htmlFor="edit-name" className="block text-sm font-medium text-[var(--color-text-muted)]">Student Name</label>
                    <input type="text" id="edit-name" name="name" value={formData.name} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label htmlFor="edit-program" className="block text-sm font-medium text-[var(--color-text-muted)]">Program</label>
                      <input type="text" id="edit-program" name="program" value={formData.program} onChange={handleChange} className={inputClass}/>
                    </div>
                    <div>
                      <label htmlFor="edit-section" className="block text-sm font-medium text-[var(--color-text-muted)]">Section</label>
                      <input type="text" id="edit-section" name="section" value={formData.section} onChange={handleChange} className={inputClass}/>
                    </div>
                  </div>
                  <div>
                    <label htmlFor="edit-session" className="block text-sm font-medium text-[var(--color-text-muted)]">Session</label>
                    <input type="text" id="edit-session" name="session" value={formData.session} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div>
                    <label htmlFor="edit-contact" className="block text-sm font-medium text-[var(--color-text-muted)]">Contact Number</label>
                    <input type="tel" id="edit-contact" name="contact" value={formData.contact || ''} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div>
                    <label htmlFor="edit-email" className="block text-sm font-medium text-[var(--color-text-muted)]">Email</label>
                    <input type="email" id="edit-email" name="email" value={formData.email || ''} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div>
                    <label htmlFor="edit-guardianName" className="block text-sm font-medium text-[var(--color-text-muted)]">Guardian's Name</label>
                    <input type="text" id="edit-guardianName" name="guardianName" value={formData.guardianName || ''} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div>
                    <label htmlFor="edit-guardianContact" className="block text-sm font-medium text-[var(--color-text-muted)]">Guardian's Contact</label>
                    <input type="tel" id="edit-guardianContact" name="guardianContact" value={formData.guardianContact || ''} onChange={handleChange} className={inputClass}/>
                  </div>
                  <div>
                    <label htmlFor="edit-notes" className="block text-sm font-medium text-[var(--color-text-muted)]">Notes</label>
                    <textarea id="edit-notes" name="notes" value={formData.notes || ''} onChange={handleChange} rows={3} className={inputClass}></textarea>
                  </div>
              </form>
          );
      };

      const AddStudentForm = ({ onAddStudent }) => {
        const [newStudent, setNewStudent] = useState({ roll: '', name: '', section: '', program: '', session: '', contact: '', email: '', guardianName: '', guardianContact: '', notes: '' });

        const handleInputChange = useCallback((e) => {
          const { name, value } = e.target;
          setNewStudent(prev => ({ ...prev, [name]: value }));
        }, []);

        const handleSubmit = (e) => {
          e.preventDefault();
          onAddStudent(newStudent);
          setNewStudent({ roll: '', name: '', section: '', program: '', session: '', contact: '', email: '', guardianName: '', guardianContact: '', notes: '' });
        };

        const inputClass = "p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";

        return (
          <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <input type="text" name="roll" placeholder="Reg No." value={newStudent.roll} onChange={handleInputChange} className={inputClass} required/>
                  <input type="text" name="name" placeholder="Student Name" value={newStudent.name} onChange={handleInputChange} className={inputClass} required/>
                  <input type="text" name="section" placeholder="Section" value={newStudent.section} onChange={handleInputChange} className={inputClass} required/>
                  <input type="text" name="program" placeholder="Program" value={newStudent.program} onChange={handleInputChange} className={inputClass} required/>
                  <input type="text" name="session" placeholder="Session (e.g., 2021-2025)" value={newStudent.session} onChange={handleInputChange} className={inputClass} required/>
                  <input type="tel" name="contact" placeholder="Contact Number (Optional)" value={newStudent.contact || ''} onChange={handleInputChange} className={inputClass}/>
                  <input type="email" name="email" placeholder="Email (Optional)" value={newStudent.email || ''} onChange={handleInputChange} className={`sm:col-span-2 ${inputClass}`}/>
                  <input type="text" name="guardianName" placeholder="Guardian's Name (Optional)" value={newStudent.guardianName || ''} onChange={handleInputChange} className={inputClass}/>
                  <input type="tel" name="guardianContact" placeholder="Guardian's Contact (Optional)" value={newStudent.guardianContact || ''} onChange={handleInputChange} className={inputClass}/>
                  <textarea name="notes" placeholder="Notes (Optional)" value={newStudent.notes || ''} onChange={handleInputChange} rows={2} className={`sm:col-span-2 ${inputClass}`}/>
              </div>
              <div className="flex justify-end pt-2">
                  <button type="submit" className="px-6 py-2 bg-[var(--color-primary)] text-[var(--color-primary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-primary-hover)] transition font-semibold">Add Student</button>
              </div>
          </form>
        );
      };


      const StudentManager = ({ students, setStudents, addToast }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedStudents, setSelectedStudents] = useState(new Set());
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);
        const [studentToEdit, setStudentToEdit] = useState(null);
        const [confirmDelete, setConfirmDelete] = useState({ type: null, payload: null });
        const [justAddedRoll, setJustAddedRoll] = useState(null);
        
        const fileInputRef = useRef(null);
        const selectAllCheckboxRef = useRef(null);

        const filteredStudents = useMemo(() => sortStudents(students).filter(student =>
          student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          student.roll.toLowerCase().includes(searchTerm.toLowerCase()) ||
          student.section.toLowerCase().includes(searchTerm.toLowerCase()) ||
          student.program.toLowerCase().includes(searchTerm.toLowerCase()) ||
          student.session.toLowerCase().includes(searchTerm.toLowerCase()) ||
          (student.email && student.email.toLowerCase().includes(searchTerm.toLowerCase()))
        ), [students, searchTerm]);

        useEffect(() => {
          if (selectAllCheckboxRef.current) {
              const allFilteredVisible = filteredStudents.length > 0 && filteredStudents.every(s => selectedStudents.has(s.roll));
              const someFilteredVisible = filteredStudents.length > 0 && filteredStudents.some(s => selectedStudents.has(s.roll));
              
              selectAllCheckboxRef.current.checked = allFilteredVisible;
              selectAllCheckboxRef.current.indeterminate = !allFilteredVisible && someFilteredVisible;
          }
        }, [selectedStudents, filteredStudents]);

        const handleAddStudent = (studentToAdd) => {
          if (!studentToAdd.roll || !studentToAdd.name || !studentToAdd.section || !studentToAdd.program || !studentToAdd.session) {
            addToast('Please fill in all required student details.', 'error');
            return;
          }
          if (students.some(s => s.roll === studentToAdd.roll)) {
            addToast('A student with this registration number already exists.', 'error');
            return;
          }
          setStudents(prev => sortStudents([...prev, studentToAdd]));
          addToast(`Student "${studentToAdd.name}" added successfully.`, 'success');
          setJustAddedRoll(studentToAdd.roll);
          setTimeout(() => setJustAddedRoll(null), 500);
        };

        const executeDeleteStudent = useCallback((roll) => {
          const studentName = students.find(s => s.roll === roll)?.name || 'the student';
          setStudents(prev => prev.filter(s => s.roll !== roll));
          setSelectedStudents(prev => {
              const newSet = new Set(prev);
              newSet.delete(roll);
              return newSet;
          });
          addToast(`Successfully deleted ${studentName}.`, 'success');
        }, [students, setStudents, addToast]);

        const executeDeleteSelected = useCallback(() => {
          const selectionSize = selectedStudents.size;
          setStudents(prev => prev.filter(s => !selectedStudents.has(s.roll)));
          setSelectedStudents(new Set());
          addToast(`${selectionSize} students deleted successfully.`, 'success');
        }, [selectedStudents, setStudents, addToast]);
        
        const handleConfirmDelete = () => {
          if (confirmDelete.type === 'single' && confirmDelete.payload) {
              executeDeleteStudent(confirmDelete.payload);
          } else if (confirmDelete.type === 'bulk') {
              executeDeleteSelected();
          }
          setConfirmDelete({ type: null, payload: null });
        };


        const handleOpenEditModal = (student) => {
          setStudentToEdit(student);
          setIsEditModalOpen(true);
        };
        
        const handleCloseEditModal = () => {
          setStudentToEdit(null);
          setIsEditModalOpen(false);
        };

        const handleUpdateStudent = (updatedStudent) => {
          setStudents(prev => {
            const updatedStudents = prev.map(s => s.roll === updatedStudent.roll ? updatedStudent : s);
            return sortStudents(updatedStudents);
          });
          addToast(`Updated details for ${updatedStudent.name}.`, 'success');
          handleCloseEditModal();
        };

        const handleCsvImport = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              const newStudents = [];
              const existingRolls = new Set(students.map(s => s.roll));
              let duplicates = 0;
              let invalid = 0;
              
              const headerMap = {
                  'reg': 'roll', 'roll': 'roll', 'reg no': 'roll', 'registration number': 'roll',
                  'student name': 'name', 'name': 'name',
                  'section': 'section', 'program': 'program', 'session': 'session',
                  'contact': 'contact', 'contact number': 'contact', 'phone': 'contact',
                  'email': 'email', 'email address': 'email',
                  'guardian name': 'guardianName', 'parent name': 'guardianName',
                  'guardian contact': 'guardianContact', 'parent contact': 'guardianContact',
                  'notes': 'notes', 'remarks': 'notes',
              };

              const mappedData = results.data.map(row => {
                  const newRow = {};
                  for (const key in row) {
                      const normalizedKey = key.trim().toLowerCase();
                      if (headerMap[normalizedKey]) {
                          newRow[headerMap[normalizedKey]] = row[key];
                      }
                  }
                  return newRow;
              });

              for (const row of mappedData) {
                const roll = row.roll?.trim();
                const name = row.name?.trim();
                const section = row.section?.trim();
                const program = row.program?.trim();
                const session = row.session?.trim();
                const contact = row.contact?.trim();
                const email = row.email?.trim();
                const guardianName = row.guardianName?.trim();
                const guardianContact = row.guardianContact?.trim();
                const notes = row.notes?.trim();

                if (!roll || !name || !section || !program || !session) {
                  invalid++;
                  continue;
                }
                if (existingRolls.has(roll)) {
                  duplicates++;
                  continue;
                }
                newStudents.push({ roll, name, section, program, session, contact, email, guardianName, guardianContact, notes });
                existingRolls.add(roll);
              }
              
              if (newStudents.length > 0) {
                  setStudents(prev => sortStudents([...prev, ...newStudents]));
              }
              
              addToast(`${newStudents.length} students imported successfully.`, 'success');
              if (duplicates > 0) addToast(`${duplicates} duplicates were skipped.`, 'info');
              if (invalid > 0) addToast(`${invalid} rows with invalid data were skipped.`, 'error');
            },
            error: (error) => {
              addToast(`Error parsing CSV: ${error.message}`, 'error');
            }
          });
          event.target.value = '';
        };
        
        const handleCsvExport = (studentList) => {
          if(studentList.length === 0) {
              addToast('No students to export.', 'info');
              return;
          }
          const csvData = sortStudents(studentList).map(s => ({
              'Reg': s.roll, 
              'Student Name': s.name, 
              'Section': s.section, 
              'Program': s.program, 
              'Session': s.session, 
              'Contact Number': s.contact || '', 
              'Email': s.email || '', 
              'Guardian Name': s.guardianName || '', 
              'Guardian Contact': s.guardianContact || '', 
              'Notes': s.notes || ''
          }));
          const csv = Papa.unparse(csvData);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', generateCsvFilename('students_list'));
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          addToast('Student data exported.', 'success');
        };
        
        const handleSelectStudent = (roll, checked) => {
          setSelectedStudents(prev => {
              const newSet = new Set(prev);
              if (checked) {
                  newSet.add(roll);
              } else {
                  newSet.delete(roll);
              }
              return newSet;
          });
        };

        const handleSelectAll = (e) => {
            if (e.target.checked) {
                setSelectedStudents(prev => new Set([...prev, ...filteredStudents.map(s => s.roll)]));
            } else {
                setSelectedStudents(prev => {
                    const newSet = new Set(prev);
                    filteredStudents.forEach(s => newSet.delete(s.roll));
                    return newSet;
                });
            }
        };
        
        const inputClass = "p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-shadow duration-200";

        return (
          <div className="space-y-6">
            <div className="bg-[var(--color-card-bg)] p-4 sm:p-6 rounded-2xl shadow-md border border-[var(--color-border)]">
              <h3 className="text-xl font-semibold mb-4 text-[var(--color-text)] flex items-center"><UsersIcon className="mr-2"/> Add New Student</h3>
              <AddStudentForm onAddStudent={handleAddStudent} />
            </div>
            
            <div className="bg-[var(--color-card-bg)] p-4 sm:p-6 rounded-2xl shadow-md border border-[var(--color-border)]">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                  <h4 className="text-xl font-semibold text-[var(--color-text)]">Student List ({students.length})</h4>
                  <div className="flex gap-2">
                    <input type="file" accept=".csv" ref={fileInputRef} onChange={handleCsvImport} className="hidden" />
                    <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium"><UploadIcon/> Import</button>
                    <button onClick={() => handleCsvExport(students)} disabled={students.length === 0} className="flex items-center gap-2 px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition disabled:opacity-50 disabled:cursor-not-allowed"><DownloadIcon/> Export</button>
                  </div>
              </div>
              
              {students.length > 0 && (
                <div className="flex items-center gap-3 mb-4">
                  <input
                    type="checkbox"
                    ref={selectAllCheckboxRef}
                    onChange={handleSelectAll}
                    className="h-5 w-5 rounded-[var(--radius-sm)] border-[var(--color-border)] bg-[var(--color-bg)] text-[var(--color-primary)] focus:ring-[var(--color-primary)] focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)]"
                    aria-label="Select all students"
                  />
                  <div className="relative w-full">
                      <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--color-text-muted)] pointer-events-none" />
                      <input
                      type="text"
                      placeholder={`Search ${students.length} students...`}
                      value={searchTerm}
                      onChange={e => setSearchTerm(e.target.value)}
                      className={`w-full pl-10 ${inputClass}`}
                      aria-label="Search students"
                      />
                  </div>
                </div>
              )}

              <div className="max-h-[50vh] overflow-y-auto -mr-3 pr-3">
                  {students.length > 0 ? (
                      filteredStudents.length > 0 ? (
                          <ul className="space-y-3">
                              {filteredStudents.map(s => (
                              <li key={s.roll} className={`flex flex-col sm:flex-row items-start sm:items-center p-4 gap-4 rounded-[var(--radius-lg)] border transition-all duration-300 ${selectedStudents.has(s.roll) ? 'bg-indigo-500/10 border-[var(--color-primary)] shadow-md' : 'bg-[var(--color-bg)] border-[var(--color-border)] hover:bg-[var(--color-secondary-bg)] hover:-translate-y-0.5 hover:shadow-md'} ${justAddedRoll === s.roll ? 'animate-fade-in-item' : ''}`}>
                                  <input
                                      type="checkbox"
                                      checked={selectedStudents.has(s.roll)}
                                      onChange={(e) => handleSelectStudent(s.roll, e.target.checked)}
                                      className="h-5 w-5 rounded-[var(--radius-sm)] border-[var(--color-border)] bg-[var(--color-card-bg)] text-[var(--color-primary)] focus:ring-[var(--color-primary)] focus:ring-offset-2 focus:ring-offset-[var(--color-bg)] shrink-0 mt-1 sm:mt-0"
                                      aria-labelledby={`student-name-${s.roll}`}
                                  />
                                  <div className="flex-grow">
                                      <p id={`student-name-${s.roll}`} className="font-semibold text-lg text-[var(--color-text)] flex items-center">
                                        {s.name}
                                        {s.notes && (
                                          <span className="ml-2" title={s.notes}>
                                            <InfoIcon className="w-5 h-5 text-sky-500 cursor-help" />
                                          </span>
                                        )}
                                      </p>
                                      <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-[var(--color-text-muted)] mt-1">
                                          <span className="font-mono bg-[var(--color-secondary-bg)] border border-[var(--color-border)] text-[var(--color-secondary-text)] px-2 py-0.5 rounded-[var(--radius-sm)] text-xs font-semibold">
                                              {s.roll}
                                          </span>
                                          <span>{s.program}</span>
                                          <span>{s.section}</span>
                                          <span>Session: {s.session}</span>
                                          {s.contact && (
                                            <a href={`tel:${s.contact}`} className="flex items-center hover:text-[var(--color-primary)] transition-colors">
                                              <PhoneIcon className="w-4 h-4 mr-1" /> {s.contact}
                                            </a>
                                          )}
                                          {s.email && (
                                            <a href={`mailto:${s.email}`} className="flex items-center hover:text-[var(--color-primary)] transition-colors">
                                              <MailIcon className="w-4 h-4 mr-1" /> {s.email}
                                            </a>
                                          )}
                                      </div>
                                  </div>
                                  <div className="flex items-center shrink-0 self-end sm:self-center ml-auto sm:ml-2">
                                      <button onClick={() => handleOpenEditModal(s)} className="text-[var(--color-text-muted)] hover:text-[var(--color-primary)] transition p-2" aria-label={`Edit ${s.name}`}><EditIcon/></button>
                                      <button onClick={() => setConfirmDelete({ type: 'single', payload: s.roll })} className="text-[var(--color-text-muted)] hover:text-red-500 transition p-2" aria-label={`Delete ${s.name}`}><TrashIcon/></button>
                                  </div>
                              </li>
                              ))}
                          </ul>
                      ) : (
                          <p className="text-center text-[var(--color-text-muted)] py-4">No students found matching your search.</p>
                      )
                  ) : (
                      <p className="text-center text-[var(--color-text-muted)] py-4">No students added yet. Add students manually or import a CSV file.</p>
                  )}
              </div>
            </div>
            
            <div className={`fixed bottom-0 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] max-w-lg z-30 transition-transform duration-300 ease-out ${selectedStudents.size > 0 ? 'translate-y-0' : 'translate-y-24'}`}>
              <div className="bg-[var(--color-card-bg)] rounded-[var(--radius-lg)] shadow-2xl p-3 flex justify-between items-center border border-[var(--color-border)]">
                  <span className="text-sm font-medium text-[var(--color-text)]">{selectedStudents.size} student(s) selected</span>
                  <div className="flex items-center gap-2">
                      <button onClick={() => handleCsvExport(students.filter(s => selectedStudents.has(s.roll)))} className="flex items-center gap-2 px-3 py-2 text-sm bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition"><DownloadIcon className="w-4 h-4" /> Export</button>
                      <button onClick={() => setConfirmDelete({ type: 'bulk', payload: null })} className="flex items-center gap-2 px-3 py-2 text-sm bg-red-500/10 text-red-500 border border-red-500/20 rounded-[var(--radius-md)] hover:bg-red-500/20 transition"><TrashIcon className="w-4 h-4" /> Delete</button>
                  </div>
              </div>
            </div>

            <Modal
              isOpen={isEditModalOpen}
              onClose={handleCloseEditModal}
              title="Edit Student Information"
              footer={
                <>
                  <button onClick={handleCloseEditModal} className="px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium">Cancel</button>
                  <button type="submit" form="edit-student-form" className="px-4 py-2 bg-[var(--color-primary)] text-[var(--color-primary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-primary-hover)] transition font-medium">Save Changes</button>
                </>
              }
            >
              {studentToEdit && (
                  <EditStudentForm student={studentToEdit} onSave={handleUpdateStudent} />
              )}
            </Modal>

            <Modal
              isOpen={confirmDelete.type !== null}
              onClose={() => setConfirmDelete({ type: null, payload: null })}
              title="Confirm Deletion"
              footer={
                  <>
                      <button onClick={() => setConfirmDelete({ type: null, payload: null })} className="px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium">Cancel</button>
                      <button onClick={handleConfirmDelete} className="px-4 py-2 bg-red-600 text-white rounded-[var(--radius-md)] hover:bg-red-700 transition font-medium">Delete</button>
                  </>
              }
              >
                  <p>
                      {confirmDelete.type === 'single'
                      ? `Are you sure you want to delete the student: ${students.find(s => s.roll === confirmDelete.payload)?.name || ''}? This action cannot be undone.`
                      : `Are you sure you want to delete the ${selectedStudents.size} selected students? This action cannot be undone.`}
                  </p>
              </Modal>
              <style>{`
                  @keyframes fade-in-item {
                      from { opacity: 0; transform: translateY(-10px); }
                      to { opacity: 1; transform: translateY(0); }
                  }
                  .animate-fade-in-item { animation: fade-in-item 0.5s ease-out forwards; }
              `}</style>

          </div>
        );
      };

      const SetupForm = ({ initialData, onSubmit }) => {
        const [formData, setFormData] = useState(initialData);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(formData);
        };
        
        const inputClass = "mt-1 block w-full p-2 border rounded-[var(--radius-md)] bg-[var(--color-bg)] border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--color-card-bg)] focus:ring-[var(--color-primary)]";
        
        return (
          <form id="setup-form" onSubmit={handleSubmit} className="space-y-4">
              <p className="text-sm">Please provide some initial details to personalize your experience. You can change these later in the settings.</p>
              <div>
                  <label htmlFor="teacherName" className="block text-sm font-medium text-[var(--color-text-muted)]">Your Display Name</label>
                  <input type="text" id="teacherName" name="teacherName" value={formData.teacherName} onChange={handleChange} required className={inputClass}/>
              </div>
              <div>
                  <label htmlFor="pdfName" className="block text-sm font-medium text-[var(--color-text-muted)]">Name on PDF Reports</label>
                  <input type="text" id="pdfName" name="pdfName" value={formData.pdfName} onChange={handleChange} required className={inputClass}/>
              </div>
              <div>
                  <label htmlFor="schoolName" className="block text-sm font-medium text-[var(--color-text-muted)]">School / Institute Name</label>
                  <input type="text" id="schoolName" name="schoolName" value={formData.schoolName} onChange={handleChange} required className={inputClass}/>
              </div>
              <div>
                  <label htmlFor="className" className="block text-sm font-medium text-[var(--color-text-muted)]">Class / Course Name</label>
                  <input type="text" id="className" name="className" value={formData.className} onChange={handleChange} required className={inputClass}/>
              </div>
          </form>
        );
      };

      const App = () => {
          const [students, setStudents] = useLocalStorage('attendance_students', []);
          const [history, setHistory] = useLocalStorage('attendance_history', []);
          const [settings, setSettings] = useLocalStorage('attendance_settings', { className: '', teacherName: 'UET Teacher', schoolName: '' });
          const [teacher, setTeacher] = useLocalStorage('attendance_teacher', {
              name: 'UET Teacher',
              email: 'uetteacher@gmail.com',
              password: 'Qasim123@'
          });
          const [theme, setTheme] = useLocalStorage('attendance_theme', 'dark');
          const [fontSize, setFontSize] = useLocalStorage('attendance_fontsize', 'medium');
          const [isSetupComplete, setIsSetupComplete] = useLocalStorage('attendance_setup_complete', false);

          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [loginError, setLoginError] = useState(null);
          
          const [isSetupModalOpen, setIsSetupModalOpen] = useState(false);

          const [attendance, setAttendance] = useState(new Map());
          const [appState, setAppState] = useState('idle');
          const [activeTab, setActiveTab] = useState('attendance');
          const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
          const [isAboutModalOpen, setIsAboutModalOpen] = useState(false);
          const [historyPdfToGenerate, setHistoryPdfToGenerate] = useState(null);
          const [toasts, setToasts] = useState([]);
          const [isProfileOpen, setIsProfileOpen] = useState(false);
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);

          const pdfRef = useRef(null);
          const profileRef = useRef(null);

          const addToast = useCallback((message, type = 'info') => {
              const id = Date.now();
              setToasts(prev => [...prev, { id, message, type }]);
              setTimeout(() => {
                  setToasts(prev => prev.filter(t => t.id !== id));
              }, 4000);
          }, []);

          useEffect(() => {
              document.documentElement.className = theme;
          }, [theme]);

          useEffect(() => {
            const sizeMap = { small: '14px', medium: '16px', large: '18px' };
            document.documentElement.style.fontSize = sizeMap[fontSize];
          }, [fontSize]);

          useEffect(() => {
              const purged = purgeOldHistory(history, 90);
              if (purged.length !== history.length) {
                  setHistory(purged);
              }
          }, []);

          useEffect(() => {
              const handleClickOutside = (event) => {
                  if (profileRef.current && !profileRef.current.contains(event.target)) {
                      setIsProfileOpen(false);
                  }
              };
              document.addEventListener("mousedown", handleClickOutside);
              return () => document.removeEventListener("mousedown", handleClickOutside);
          }, []);

          const handleLogin = (email, pass) => {
              if (email.trim().toLowerCase() === teacher.email.trim().toLowerCase() && pass === teacher.password) {
                  setIsLoggedIn(true);
                  setLoginError(null);
                  if (!isSetupComplete) {
                      setIsSetupModalOpen(true);
                  } else {
                      addToast(`Welcome back, ${teacher.name}!`, 'success');
                  }
              } else {
                  setLoginError('Invalid email or password.');
              }
          };

          const handleSetupSubmit = (data) => {
              const { teacherName, pdfName, schoolName, className } = data;

              if (!teacherName.trim() || !pdfName.trim() || !schoolName.trim() || !className.trim()) {
                  addToast('Please fill out all fields.', 'error');
                  return;
              }

              setTeacher(prev => ({ ...prev, name: teacherName }));
              setSettings({
                  teacherName: pdfName,
                  schoolName,
                  className
              });

              setIsSetupComplete(true);
              setIsSetupModalOpen(false);
              addToast('Setup complete! Welcome to Attendly.', 'success');
          };

          const handleLogout = () => {
              setIsLoggedIn(false);
              resetSession();
              setActiveTab('attendance');
              addToast('You have been logged out.', 'info');
          };

          const startAttendance = () => {
              setAttendance(new Map());
              setAppState('taking_attendance');
              setActiveTab('attendance');
          };

          const handleCompleteAttendance = () => {
              setAppState('summary');
          };

          const resetSession = useCallback(() => {
              setAttendance(new Map());
              setAppState('idle');
          }, []);

          const performPdfGeneration = useCallback(async (title) => {
              if (!pdfRef.current) {
                  console.error("PDF generation failed: document reference is not available.");
                  addToast("PDF generation failed: document not ready.", "error");
                  return;
              }
              const filename = generatePdfFilename();
              try {
                  const { jsPDF } = jspdf;
                  const pdf = new jsPDF('p', 'mm', 'a4');
                  pdf.setDocumentProperties({ title });

                  const pdfWidth = pdf.internal.pageSize.getWidth();
                  const pdfHeight = pdf.internal.pageSize.getHeight();

                  const canvas = await html2canvas(pdfRef.current, {
                      scale: 2,
                      useCORS: true,
                  });

                  const imgData = canvas.toDataURL('image/png');
                  const imgProps = pdf.getImageProperties(imgData);
                  
                  const totalImgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                  let heightLeft = totalImgHeight;
                  let position = 0;
                  let pageCount = 1;

                  pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, totalImgHeight);
                  heightLeft -= pdfHeight;

                  while (heightLeft > 0) {
                      position -= pdfHeight;
                      pdf.addPage();
                      pageCount++;
                      pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, totalImgHeight);
                      heightLeft -= pdfHeight;
                  }
                  
                  pdf.save(filename);
                  
                  addToast(
                      `PDF generated (${pageCount} ${pageCount > 1 ? 'pages' : 'page'}).`, 
                      "success"
                  );
              } catch (error) {
                  console.error("PDF generation failed.", error);
                  addToast("Failed to generate PDF. Please try again.", "error");
              }
          }, [addToast]);
          
          const handleExportAttendanceCsv = () => {
              const date = new Date().toLocaleDateString('en-CA');
              const csvData = students.map(student => {
                  const record = attendance.get(student.roll);
                  return {
                      'Roll No': student.roll,
                      'Name': student.name,
                      'Status': record?.status || 'Not Marked',
                      'Date': date,
                      'Reason': record?.status === 'Leave' ? record.reason : '',
                  };
              });
              
              const csv = Papa.unparse(csvData);
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', generateCsvFilename('attendance'));
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              addToast("Attendance CSV exported.", "success");
          };

          const generatePdfAndSave = useCallback(async () => {
              if (isGeneratingPdf) return;
              setIsGeneratingPdf(true);
              
              const timestamp = Date.now();
              const pdfTitle = `Attendance Report - ${settings.className || 'Class'} - ${new Date(timestamp).toLocaleDateString()}`;
              await performPdfGeneration(pdfTitle);

              const { presentCount, absentCount, leaveCount, bunkCount } = getAttendanceCounts(attendance);
              const newHistoryEntry = {
                  id: `hist_${timestamp}`,
                  timestamp,
                  presentCount,
                  absentCount,
                  leaveCount,
                  bunkCount,
                  settings: { ...settings, teacherName: settings.teacherName || teacher.name },
                  attendanceData: Array.from(attendance.entries()),
              };
              setHistory(prev => [...prev, newHistoryEntry]);

              setIsGeneratingPdf(false);
              resetSession();

          }, [isGeneratingPdf, attendance, settings, teacher.name, setHistory, resetSession, performPdfGeneration]);
          
          const handleRegeneratePdf = useCallback((entry) => {
              if (isGeneratingPdf) return;
              setIsGeneratingPdf(true);
              setHistoryPdfToGenerate(entry);
          }, [isGeneratingPdf]);

          useEffect(() => {
              if (historyPdfToGenerate) {
                  const generate = async () => {
                      const pdfTitle = `Attendance Report - ${historyPdfToGenerate.settings.className || 'Class'} - ${new Date(historyPdfToGenerate.timestamp).toLocaleDateString()}`;
                      await performPdfGeneration(pdfTitle);
                      setIsGeneratingPdf(false);
                      setHistoryPdfToGenerate(null);
                  };
                  setTimeout(generate, 100);
              }
          }, [historyPdfToGenerate, performPdfGeneration]);

          const renderContent = () => {
              switch (activeTab) {
                  case 'students':
                      return <StudentManager students={students} setStudents={setStudents} addToast={addToast} />;
                  case 'history':
                      return <HistoryViewer history={history} setHistory={setHistory} onRegeneratePdf={handleRegeneratePdf} isGeneratingPdf={isGeneratingPdf} addToast={addToast} />;
                  case 'settings':
                      return <SettingsEditor 
                                  settings={settings} 
                                  setSettings={setSettings} 
                                  teacher={teacher}
                                  setTeacher={setTeacher}
                                  theme={theme}
                                  setTheme={setTheme}
                                  fontSize={fontSize}
                                  setFontSize={setFontSize}
                                  onOpenAbout={() => setIsAboutModalOpen(true)}
                                  addToast={addToast}
                              />;
                  case 'attendance':
                  default:
                      if (appState === 'taking_attendance') {
                          return <AttendanceTaker students={students} setAttendance={setAttendance} onComplete={handleCompleteAttendance} />;
                      }
                      return (
                          <div className="flex flex-col items-center justify-center h-[calc(100vh-220px)] text-center p-4">
                              <div className="p-10 bg-[var(--color-card-bg)] rounded-3xl shadow-md border border-[var(--color-border)]">
                                <h2 className="text-3xl font-bold text-[var(--color-text)] mb-2">Welcome, {teacher.name}!</h2>
                                <p className="text-lg text-[var(--color-text-muted)] mb-8">Ready to start a new attendance session?</p>
                                <button 
                                    onClick={startAttendance}
                                    disabled={students.length === 0}
                                    className="px-10 py-4 text-lg bg-[var(--color-primary)] text-[var(--color-primary-text)] font-semibold rounded-[var(--radius-lg)] shadow-lg hover:bg-[var(--color-primary-hover)] transition-all duration-200 transform hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none"
                                >
                                    Start New Session
                                </button>
                                {students.length === 0 && <p className="text-sm mt-4 text-red-500">Please add students on the "Students" page before starting.</p>}
                              </div>
                          </div>
                      );
              }
          };
          
          const { presentStudents, absentStudents, leaveStudents, bunkStudents } = getStudentListsByStatus(students, attendance);

          const SidebarLink = ({ tabName, icon, label }) => (
              <button
                  onClick={() => {
                      setActiveTab(tabName);
                      setIsSidebarOpen(false); // Close sidebar on selection
                  }}
                  className={`flex items-center gap-3 px-4 py-3 w-full text-left rounded-[var(--radius-lg)] font-semibold transition-all duration-200 ${activeTab === tabName ? 'bg-[var(--color-primary)] text-[var(--color-primary-text)] shadow-md' : 'text-[var(--color-text-muted)] hover:bg-[var(--color-secondary-bg)] hover:text-[var(--color-text)]'}`}
              >
                  {icon}
                  <span>{label}</span>
              </button>
          );
          
          const pageTitles = {
              attendance: 'Attendance',
              students: 'Manage Students',
              history: 'Attendance History',
              settings: 'Settings',
          };
          
          const pdfData = historyPdfToGenerate 
              ? { attendanceData: new Map(historyPdfToGenerate.attendanceData), settings: historyPdfToGenerate.settings, timestamp: historyPdfToGenerate.timestamp } 
              : { attendanceData: attendance, settings: { ...settings, teacherName: settings.teacherName || teacher.name }, timestamp: Date.now() };

          if (!isLoggedIn) {
              return <Login onLogin={handleLogin} error={loginError} />;
          }

          return (
              <div className="min-h-screen text-[var(--color-text)] flex relative lg:static">
                  <div className="fixed top-5 right-5 z-[100] space-y-2">
                      {toasts.map(toast => {
                          const colors = {
                              success: 'bg-green-500',
                              error: 'bg-red-500',
                              info: 'bg-sky-500',
                          };
                          return (
                              <div key={toast.id} className={`flex items-center gap-3 ${colors[toast.type]} text-white py-2 px-4 rounded-[var(--radius-lg)] shadow-lg animate-toast-in`}>
                                  {toast.type === 'info' && <InfoIcon className="w-5 h-5" />}
                                  {toast.type === 'success' && <CheckIcon className="w-5 h-5" />}
                                  {toast.type === 'error' && <XIcon className="w-5 h-5" />}
                                  <span>{toast.message}</span>
                              </div>
                          )
                      })}
                  </div>
                  
                  {isSidebarOpen && (
                      <div 
                          className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden"
                          onClick={() => setIsSidebarOpen(false)}
                      ></div>
                  )}

                  <aside className={`fixed lg:relative h-full w-64 bg-[var(--color-card-bg)] border-r border-[var(--color-border)] p-4 flex flex-col shrink-0 z-50 transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                      <h1 className="text-4xl font-extrabold tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-[var(--color-primary)] to-pink-500 px-2 py-4">Attendly</h1>
                      <nav className="flex flex-col space-y-2 mt-4">
                          <SidebarLink tabName="attendance" icon={<ListIcon/>} label="Attendance" />
                          <SidebarLink tabName="students" icon={<UsersIcon/>} label="Students" />
                          <SidebarLink tabName="history" icon={<CalendarIcon/>} label="History" />
                          <SidebarLink tabName="settings" icon={<SettingsIcon/>} label="Settings" />
                      </nav>
                      <div className="mt-auto text-center text-xs text-[var(--color-text-muted)]">
                          <button onClick={() => setIsAboutModalOpen(true)} className="hover:text-[var(--color-primary)] transition">About Developer</button>
                          <p className="mt-1">© {new Date().getFullYear()} Attendly</p>
                      </div>
                  </aside>
                  
                  <div className="flex-grow flex flex-col w-full">
                      <header className="bg-[var(--color-card-bg)]/80 backdrop-blur-sm border-b border-[var(--color-border)] p-4 sticky top-0 z-30">
                          <div className="flex justify-between items-center">
                              <div className="flex items-center gap-4">
                                  <button onClick={() => setIsSidebarOpen(true)} className="lg:hidden p-2 text-[var(--color-text-muted)] hover:text-[var(--color-text)]">
                                      <MenuIcon />
                                  </button>
                                  <h2 className="text-2xl font-bold text-[var(--color-text)]">{pageTitles[activeTab]}</h2>
                              </div>
                              <div ref={profileRef} className="relative">
                                <button onClick={() => setIsProfileOpen(p => !p)} className="flex items-center gap-2 p-2 rounded-[var(--radius-lg)] hover:bg-[var(--color-secondary-bg)] transition">
                                    <div className="w-8 h-8 rounded-full bg-[var(--color-primary)] text-[var(--color-primary-text)] flex items-center justify-center font-bold">{teacher.name.charAt(0)}</div>
                                    <div className="hidden sm:block text-left">
                                        <div className="font-semibold text-[var(--color-text)] leading-tight">{teacher.name}</div>
                                        <div className="text-xs text-[var(--color-text-muted)] leading-tight">{teacher.email}</div>
                                    </div>
                                </button>
                                {isProfileOpen && (
                                    <div className="absolute top-full right-0 mt-2 w-48 bg-[var(--color-card-bg)] rounded-[var(--radius-lg)] shadow-xl border border-[var(--color-border)] py-1 z-50 animate-fade-in-fast">
                                        <button onClick={handleLogout} className="w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-[var(--color-text-muted)] hover:bg-[var(--color-secondary-bg)] hover:text-red-500 transition-colors">
                                            <LogOutIcon />
                                            Logout
                                        </button>
                                    </div>
                                )}
                              </div>
                          </div>
                      </header>

                      <main className="flex-grow p-4 sm:p-6 lg:p-8 overflow-y-auto">
                          <div key={activeTab} className="animate-fade-in">
                              {renderContent()}
                          </div>
                      </main>
                  </div>


                  <Modal isOpen={appState === 'summary'} onClose={resetSession} title="Attendance Summary" footer={
                      <>
                          <button onClick={resetSession} className="px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium">Cancel</button>
                          <button onClick={handleExportAttendanceCsv} className="flex items-center gap-2 px-4 py-2 bg-[var(--color-secondary-bg)] text-[var(--color-secondary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-secondary-hover)] transition font-medium">
                            <DownloadIcon/> Export CSV
                          </button>
                          <button onClick={generatePdfAndSave} disabled={isGeneratingPdf} className="px-4 py-2 bg-[var(--color-primary)] text-[var(--color-primary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-primary-hover)] transition font-medium disabled:opacity-50 disabled:cursor-wait">
                              {isGeneratingPdf ? 'Generating...' : 'Generate PDF & Save'}
                          </button>
                      </>
                  }>
                      <div className="space-y-4 max-h-[60vh] overflow-y-auto p-1">
                          <div className="bg-green-500/10 p-3 rounded-[var(--radius-lg)]">
                              <h4 className="text-lg font-semibold flex items-center text-green-500 mb-2"><CheckIcon className="mr-2"/> Present ({presentStudents.length})</h4>
                              {presentStudents.length > 0 ? (
                                  <ul className="space-y-1 text-sm text-[var(--color-text-muted)] grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                                      {presentStudents.map(s => <li key={s.roll} className="flex items-center gap-2"><span className="font-mono bg-[var(--color-secondary-bg)] px-1.5 py-0.5 rounded-[var(--radius-sm)] text-xs">{s.roll}</span><span>{s.name}</span></li>)}
                                  </ul>
                              ) : <p className="text-sm text-[var(--color-text-muted)] italic pl-1">No students were present.</p>}
                          </div>
                          <div className="bg-red-500/10 p-3 rounded-[var(--radius-lg)]">
                              <h4 className="text-lg font-semibold flex items-center text-red-500 mb-2"><XIcon className="mr-2"/> Absent ({absentStudents.length})</h4>
                              {absentStudents.length > 0 ? (
                                  <ul className="space-y-1 text-sm text-[var(--color-text-muted)] grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                                      {absentStudents.map(s => <li key={s.roll} className="flex items-center gap-2"><span className="font-mono bg-[var(--color-secondary-bg)] px-1.5 py-0.5 rounded-[var(--radius-sm)] text-xs">{s.roll}</span><span>{s.name}</span></li>)}
                                  </ul>
                              ) : <p className="text-sm text-[var(--color-text-muted)] italic pl-1">No students were absent.</p>}
                          </div>
                          <div className="bg-orange-500/10 p-3 rounded-[var(--radius-lg)]">
                              <h4 className="text-lg font-semibold flex items-center text-orange-500 mb-2"><BanIcon className="mr-2"/> Bunk ({bunkStudents.length})</h4>
                              {bunkStudents.length > 0 ? (
                                  <ul className="space-y-1 text-sm text-[var(--color-text-muted)] grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                                      {bunkStudents.map(s => <li key={s.roll} className="flex items-center gap-2"><span className="font-mono bg-[var(--color-secondary-bg)] px-1.5 py-0.5 rounded-[var(--radius-sm)] text-xs">{s.roll}</span><span>{s.name}</span></li>)}
                                  </ul>
                              ) : <p className="text-sm text-[var(--color-text-muted)] italic pl-1">No students bunked.</p>}
                          </div>
                          <div className="bg-yellow-500/10 p-3 rounded-[var(--radius-lg)]">
                              <h4 className="text-lg font-semibold flex items-center text-yellow-500 mb-2"><FileTextIcon className="mr-2"/> On Leave ({leaveStudents.length})</h4>
                              {leaveStudents.length > 0 ? (
                                  <ul className="space-y-1 text-sm text-[var(--color-text-muted)]">
                                      {leaveStudents.map(s => (
                                          <li key={s.student.roll}>
                                              <div className="flex items-center gap-2">
                                                  <span className="font-mono bg-[var(--color-secondary-bg)] px-1.5 py-0.5 rounded-[var(--radius-sm)] text-xs">{s.student.roll}</span>{s.student.name}
                                              </div>
                                              {s.reason && <div className="pl-8 text-xs italic opacity-80">"{s.reason}"</div>}
                                          </li>
                                      ))}
                                  </ul>
                              ) : <p className="text-sm text-[var(--color-text-muted)] italic pl-1">No students were on leave.</p>}
                          </div>
                      </div>
                  </Modal>
                  
                  <Modal isOpen={isAboutModalOpen} onClose={() => setIsAboutModalOpen(false)} title="About Attendly">
                      <div className="space-y-4 text-center">
                          <div className="flex justify-center">
                              <div className="w-16 h-16 rounded-full bg-gradient-to-br from-[var(--color-primary)] to-pink-500 text-[var(--color-primary-text)] flex items-center justify-center text-3xl font-bold">
                                  ES
                              </div>
                          </div>
                          <div>
                              <p className="text-lg font-semibold text-[var(--color-text)]">Developed by Ehtisham Sabir</p>
                              <p className="text-sm text-[var(--color-text-muted)]">Version 2.0.0</p>
                          </div>
                          <p className="text-sm">
                              Attendly is a modern, offline-first attendance management system designed to be fast, reliable, and user-friendly for educators.
                          </p>
                          <p className="text-sm">
                              This application is built with a focus on clean code, robust performance, and an intuitive user experience, leveraging the latest in frontend technologies.
                          </p>
                          <p className="text-sm pt-4 border-t border-[var(--color-border)]">
                              <strong>Tech Stack:</strong> React 18, Tailwind CSS, jsPDF
                          </p>
                      </div>
                  </Modal>

                  <Modal
                      isOpen={isSetupModalOpen}
                      onClose={() => {}} 
                      title="Welcome! Let's get you set up."
                      hideCloseButton={true}
                      footer={
                          <button type="submit" form="setup-form" className="w-full px-6 py-2 bg-[var(--color-primary)] text-[var(--color-primary-text)] rounded-[var(--radius-md)] hover:bg-[var(--color-primary-hover)] transition font-semibold">
                              Save and Continue
                          </button>
                      }
                  >
                      <SetupForm 
                          initialData={{
                              teacherName: teacher.name,
                              pdfName: settings.teacherName,
                              schoolName: settings.schoolName,
                              className: settings.className,
                          }}
                          onSubmit={handleSetupSubmit}
                      />
                  </Modal>

                  <div className="absolute -left-full top-0 -z-10">
                      {(appState === 'summary' || historyPdfToGenerate) && <PdfDocument ref={pdfRef} students={students} attendanceData={pdfData.attendanceData} settings={pdfData.settings} timestamp={pdfData.timestamp} />}
                  </div>
                  <style>{`
                      @keyframes fade-in {
                          from { opacity: 0; transform: translateY(10px); }
                          to { opacity: 1; transform: translateY(0); }
                      }
                      .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }

                      @keyframes fade-in-fast {
                          from { opacity: 0; transform: translateY(-5px); }
                          to { opacity: 1; transform: translateY(0); }
                      }
                      .animate-fade-in-fast { animation: fade-in-fast 0.2s ease-out forwards; }
                      
                      @keyframes fade-in-out {
                          0% { opacity: 0; transform: translateY(-20px); }
                          10% { opacity: 1; transform: translateY(0); }
                          90% { opacity: 1; transform: translateY(0); }
                          100% { opacity: 0; transform: translateY(-20px); }
                      }
                      .animate-fade-in-out { animation: fade-in-out 3s ease-in-out forwards; }

                      @keyframes toast-in {
                          from { opacity: 0; transform: translateX(100%); }
                          to { opacity: 1; transform: translateX(0); }
                      }
                      .animate-toast-in { animation: toast-in 0.5s cubic-bezier(0.21, 1.02, 0.73, 1) forwards; }

                      @keyframes slide-out-left { from { transform: translateX(0) rotate(0); opacity: 1; } to { transform: translateX(-150%) rotate(-20deg); opacity: 0; } }
                      .animate-slide-out-left { animation: slide-out-left 0.4s ease-out forwards; }
                      
                      @keyframes slide-out-right { from { transform: translateX(0) rotate(0); opacity: 1; } to { transform: translateX(150%) rotate(20deg); opacity: 0; } }
                      .animate-slide-out-right { animation: slide-out-right 0.4s ease-out forwards; }

                      @keyframes slide-out-up { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(-150%) scale(0.8); opacity: 0; } }
                      .animate-slide-out-up { animation: slide-out-up 0.4s ease-out forwards; }

                      @keyframes slide-out-down { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(150%) scale(0.8); opacity: 0; } }
                      .animate-slide-out-down { animation: slide-out-down 0.4s ease-out forwards; }
                  `}</style>
              </div>
          );
      };

      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <StrictMode>
            <App />
          </StrictMode>
        );
      } else {
        console.error("Could not find root element to mount to");
      }
    </script>
  </body>
</html>